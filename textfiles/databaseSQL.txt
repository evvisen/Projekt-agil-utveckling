CREATE DATABASE vuxenpoäng;

USE vuxenpoäng;


-- skapa grundtabeller


CREATE TABLE modules (
    module_id INT NOT NULL AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL,
    description TEXT,
    PRIMARY KEY (module_id)
);

CREATE TABLE module_levels (
    module_level_id INT AUTO_INCREMENT,
    module_ml_id INT NOT NULL,
    level_number INT NOT NULL,
    mongo_quiz_id VARCHAR(50) NOT NULL,
    UNIQUE (module_ml_id, level_number),
    PRIMARY KEY (module_level_id),
    FOREIGN KEY (module_ml_id) REFERENCES modules(module_id)
);

CREATE TABLE Users (
    user_id INT NOT NULL AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    current_level INT,
    PRIMARY KEY (user_id),
    FOREIGN KEY (current_level) REFERENCES module_levels(module_level_id)
);

CREATE TABLE user_module_progress (
    user_module_progress_id INT NOT NULL AUTO_INCREMENT,
    user_id_UMP INT NOT NULL ,
    module_level_UMP_id INT NOT NULL,
    status ENUM('locked', 'unlocked', 'completed') DEFAULT 'locked',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    completed_at DATETIME NULL, -- kan vara null tills den är completed
    UNIQUE (user_id_UMP, module_level_UMP_id), -- så en user inte kan ha fler status per level
    PRIMARY KEY (user_module_progress_id),
    FOREIGN KEY (user_id_UMP) REFERENCES Users(user_id) ON DELETE CASCADE,
    FOREIGN KEY (module_level_UMP_id) REFERENCES module_levels(module_level_id)
);



-- dummy data


INSERT INTO modules (name, description)
VALUES
('Juridik', 'Grunder i vardagsjuridik'),
('Privatekonomi', 'Pengar, sparande och budget');

INSERT INTO module_levels (module_ml_id, level_number, mongo_quiz_id)
VALUES
(1, 1, 'juridik_lvl1'),
(1, 2, 'juridik_lvl_2'),
(2, 1, 'ekonomi_lvl_1');

INSERT INTO Users (username,current_level, password_hash)
VALUES ('användare1',1, 'hashedpassword123');

INSERT INTO user_module_progress ( user_id_UMP, module_level_UMP_id, status)
VALUES
(2, 1, 'completed'),
(2, 2, 'unlocked'),
(2, 3, 'locked');


-- SELECT FRÅGOR

SELECT * FROM Users;
SELECT * FROM modules;
SELECT * FROM module_levels;
SELECT * FROM user_module_progress;

-- INNER JOIN

-- Visa användarens hela progress (Dashboard)
SELECT u.username, m.name AS module, ml.level_number, ml.mongo_quiz_id, ump.status, ump.completed_at
FROM Users u
INNER JOIN user_module_progress ump on u.user_id = ump.user_id_UMP
INNER JOIN module_levels ml on ump.module_level_UMP_id = ml.module_level_id
INNER JOIN modules m on ml.module_ml_id = m.module_id
WHERE u.user_id = 2;

-- visa vilka quiz användaren får spela (alla som inte har status "locked"
SELECT ml.mongo_quiz_id, m.name AS module, ml.level_number
FROM user_module_progress ump
INNER JOIN module_levels ml on ump.module_level_UMP_id = ml.module_level_id
INNER JOIN modules m on ml.module_ml_id = m.module_id
WHERE ump.user_id_UMP=2
AND ump.status IN ('completed','unlocked');

-- visa nästa level användaren ska spela
SELECT ml.*
FROM user_module_progress ump
INNER JOIN module_levels ml on ump.module_level_UMP_id = ml.module_level_id
WHERE ump.user_id_UMP=2 AND ump.status= 'unlocked'
ORDER BY ml.level_number
LIMIT 1;

-- Räkna hur många levels användaren klarat
SELECT COUNT(*) AS completed_levels
FROM user_module_progress
WHERE user_id_UMP=2 AND status= 'completed';


-- unlock nästa level (check)
SELECT * FROM module_levels WHERE module_ml_id=1 AND level_number=2;


DROP TABLE modules;
DROP TABLE module_levels;
DROP TABLE Users;
DROP TABLE user_module_progress;


DROP DATABASE vuxenpoäng;

